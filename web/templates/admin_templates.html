{% extends "codemirror.html" %}

{% block title %}
Templates Editor
{% endblock title %}

{% block content %}
	<style>
		.back-link {
			display: inline-flex;
			align-items: center;
			margin-bottom: 20px;
			color: var(--link-color);
			text-decoration: none;
		}

		.back-link:hover {
			text-decoration: underline;
		}

		.card-btn:hover {
			background-color: #f8f9fa;
		}

		.form-select {
			margin-bottom: 20px;
		}

		#templateSelector {
			width: 100%;
			max-width: 600px;
		}

		#newTemplateInput {
			margin-top: 10px;
		}

		#newTemplateInput::placeholder {
			color: #999;
			opacity: 1;
		}
	</style>

	<a href="/admin" class="back-link">
		<svg width="20" height="20" style="vertical-align: middle; margin-right: 5px;">
			<use href="/static/sprites.svg#back"></use>
		</svg>
		Back to Admin Panel
	</a>

	<h2>Templates Editor</h2>

	<div class="card">
		<div class="card-body">
			<form id="editorForm">
				<div class="row mb-3">
					<div class="col-md-6">
						<label for="templateSelector" class="form-label">Select Template:</label>
						<select id="templateSelector" class="form-select" onchange="loadTemplate()">
							<option value="">-- Select a template --</option>
							{% for template in templates %}
								<option value="{{ template }}">{{ template }}</option>
							{% endfor %}
						</select>
					</div>
					
					<div class="col-md-6">
						<label for="newTemplateInput" class="form-label">Create New Template:</label>
						<input type="text" id="newTemplateInput" class="form-control" placeholder="filename.S or filename.c">
						<small class="form-text text-muted">Enter a filename with .S or .c extension</small>
						<div class="card card-btn mt-2">
							<a href="#" onclick="createNewTemplate(); return false;" class="card-body text-center text-decoration-none">
								Create
							</a>
						</div>
					</div>
				</div>

				<div class="mb-3">
					<label for="code">Template Code:</label><br>
					<textarea class="form-control" id="code" name="code" style="width:100%; display:none;"></textarea>
					<div id="codeMirror"></div>
				</div>
				<div class="row">
					<div class="col-8">
						<div class="card card-btn">
							<a href="#" onclick="saveFile(); return false;" class="card-body text-center text-decoration-none">
								Save
							</a>
						</div>
					</div>
					<div class="col-4">
						<div class="card card-btn">
							<a href="#" onclick="resetCode(); return false;" class="card-body text-center text-decoration-none">
								Reset
							</a>
						</div>
					</div>
				</div>
			</form>
		</div>
	</div>
{% endblock content %}

{% block cmirror %}
	<script>
		let textarea = document.getElementById('code');
		let currentFilename = null;
		let originalContent = '';

		let editor = CodeMirror(document.getElementById("codeMirror"), {
			lineNumbers: true,
			mode: "gas",
			lineWrapping: true,
			viewportMargin: Infinity,
			{% if user_theme and user_theme != 'default' %}theme: "{{ user_theme }}",{% endif %}
			value: '',
			readOnly: true
		});

		editor.setSize("auto", "auto");

		function loadTemplate() {
			const selector = document.getElementById('templateSelector');
			const filename = selector.value;
			
			if (!filename) {
				editor.setValue('');
				editor.setOption('readOnly', true);
				currentFilename = null;
				originalContent = '';
				return;
			}

			currentFilename = filename;

			// Set editor mode based on file extension
			if (filename.endsWith('.c')) {
				editor.setOption('mode', 'text/x-csrc');
			} else {
				editor.setOption('mode', 'gas');
			}

			// Load template file content
			fetch('/admin/templates/load/' + encodeURIComponent(filename))
				.then(response => response.json())
				.then(data => {
					if (data.error) {
						alert('Error loading template: ' + data.error);
						return;
					}
					originalContent = data.content;
					editor.setValue(data.content);
					editor.setOption('readOnly', false);
				})
				.catch(error => {
					alert('Error loading template: ' + error);
				});
		}

		function createNewTemplate() {
			const input = document.getElementById('newTemplateInput');
			const filename = input.value.trim();

			if (!filename) {
				alert('Please enter a filename');
				return;
			}

			if (!filename.endsWith('.S') && !filename.endsWith('.c')) {
				alert('Filename must end with .S or .c');
				return;
			}

			const formData = new FormData();
			formData.append('filename', filename);

			fetch('/admin/templates/create', {
				method: 'POST',
				body: formData
			})
			.then(response => response.json())
			.then(data => {
				if (data.error) {
					alert('Error creating template: ' + data.error);
				} else {
					alert('Template created successfully!');
					// Add to selector and load it
					const selector = document.getElementById('templateSelector');
					const option = document.createElement('option');
					option.value = data.filename;
					option.text = data.filename;
					
					// Insert alphabetically
					let inserted = false;
					for (let i = 1; i < selector.options.length; i++) {
						if (selector.options[i].value > data.filename) {
							selector.add(option, selector.options[i]);
							inserted = true;
							break;
						}
					}
					if (!inserted) {
						selector.add(option);
					}
					
					selector.value = data.filename;
					input.value = '';
					loadTemplate();
				}
			})
			.catch(error => {
				alert('Error creating template: ' + error);
			});
		}

		function saveFile() {
			if (!currentFilename) {
				alert('Please select a template first');
				return;
			}

			if (!confirm('Are you sure you want to save changes to this template file? This will overwrite the current file.')) {
				return;
			}

			const content = editor.getValue();
			const formData = new FormData();
			formData.append('content', content);

			fetch('/admin/templates/save/' + encodeURIComponent(currentFilename), {
				method: 'POST',
				body: formData
			})
			.then(response => response.json())
			.then(data => {
				if (data.error) {
					alert('Error saving file: ' + data.error);
				} else {
					alert('File saved successfully!');
					originalContent = content;
				}
			})
			.catch(error => {
				alert('Error saving file: ' + error);
			});
		}

		function resetCode() {
			if (!currentFilename) {
				alert('Please select a template first');
				return;
			}

			if (confirm('Reset to the last saved version?')) {
				editor.setValue(originalContent);
			}
		}
	</script>
{% endblock %}
