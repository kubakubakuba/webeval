{% extends "codemirror.html" %}

{% block title %}
	{{ task_name }}
{% endblock title %}

{% block content %}
	<style>
		.back-link {
			display: inline-flex;
			align-items: center;
			margin-bottom: 20px;
			color: var(--link-color);
			text-decoration: none;
		}

		.back-link:hover {
			text-decoration: underline;
		}

		.card-btn:hover {
			background-color: #f8f9fa;
		}
		
		/* Error line highlighting */
		.error-line {
			background-color: rgba(255, 0, 0, 0.15) !important;
		}
		
		html.dark-mode .error-line {
			background-color: rgba(255, 0, 0, 0.25) !important;
		}
		
		.error-line-gutter {
			background-color: rgba(255, 0, 0, 0.3) !important;
			color: #fff !important;
		}
	</style>

	<a href="/task/{{ task_id }}" class="back-link">
		<svg width="20" height="20" style="vertical-align: middle; margin-right: 5px;">
			<use href="/static/sprites.svg#back"></use>
		</svg>
		Back to Task
	</a>

	<h2>Submission for task: {{ task_name }}</h2>
	<details>
		<summary>Task description (click)</summary>
		{{ task_description | safe}}
	</details>
	<div class="card">
		<div class="card-body">
			<form method="post" id="codeForm">
				<div class="mb-3">
					<label for="code">Paste your code below:</label><br>
					<textarea class="form-control" id="code" name="code" style="width:600px; display:none;"></textarea>
					<div id="codeMirror"></div>
				</div>
				<div class="row">
					<div class="col-8">
						<div class="card card-btn">
							<a href="#" onclick="submitForm();" class="card-body text-center text-decoration-none">
								Submit
							</a>
						</div>
					</div>
					<div class="col-4">
						<div class="card card-btn">
							<a href="#" onclick="resetCode();" class="card-body text-center text-decoration-none">
								Reset
							</a>
						</div>
					</div>
				</div>
			</form>
		</div>
	</div>
{% endblock content %}

{% block cmirror %}
	<script>
		let textarea = document.getElementById('code');
		let templateContent = {{template_code|tojson}};
		let submissionContent = {{submission_code|tojson}};
		let errorLog = {{error_log|tojson}};

		if (submissionContent == null) {
			submissionContent = templateContent;
		}

		let editor = CodeMirror(document.getElementById("codeMirror"), {
			lineNumbers: true,
			mode: "{% if language == 'c' %}text/x-csrc{% else %}gas{% endif %}",
			lineWrapping: true,
			viewportMargin: Infinity,
			{% if user_theme and user_theme != 'default' %}theme: "{{ user_theme }}",{% endif %}
			value: textarea.value
		});

		editor.setSize("auto", "auto");
		editor.setValue(submissionContent);

		//parse error for error lines
		if (errorLog) {
			//matches "On line 1 in your code:" or "line 5:"
			const linePattern = /(?:On line|line)\s+(\d+)/gi;
			let match;
			const errorLines = new Set();
			
			while ((match = linePattern.exec(errorLog)) !== null) {
				errorLines.add(parseInt(match[1]) - 1); //0 based idx
			}
			
			//highlight
			errorLines.forEach(lineNum => {
				if (lineNum >= 0 && lineNum < editor.lineCount()) {
					editor.addLineClass(lineNum, "background", "error-line");
					editor.addLineClass(lineNum, "gutter", "error-line-gutter");
				}
			});
		}

		function submitForm() {
			textarea.value = editor.getValue();
			document.getElementById('codeForm').submit();
		}

		function resetCode() { //change from template code to submission code and vice versa
			editor.setValue(templateContent);
			let temp = templateContent;
			templateContent = submissionContent;
			submissionContent = temp;
		}
	</script>
{% endblock %}