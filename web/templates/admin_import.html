{% extends "base_wide.html" %}

{% block title %}Batch Import Users{% endblock %}

{% block content %}
<style>
.back-link {
	display: inline-flex;
	align-items: center;
    color: var(--link-color);
    text-decoration: none;
}

.back-link:hover {
    text-decoration: underline;
}

.card-btn {
    cursor: pointer;
}

.card-btn:hover {
    background-color: #f8f9fa;
}

/* Custom container override */
.container-fluid.import-container {
    max-width: none !important;
    padding: 25px !important;
    width: 100%;
}

/* Content styling */
.csv-format-section {
    padding-right: 25px;
}
.upload-section {
    padding-left: 25px;
    border-left: 1px solid #dee2e6;
}
html.dark-mode .upload-section {
    border-left-color: #444;
}
.table-column {
    padding-top: 25px;
}
/* Table adjustments */
.table-container {
    overflow-x: auto;
}
table {
    min-width: 600px;
}
</style>

<a href="/admin" class="back-link">
	<svg width="20" height="20" style="vertical-align: middle; margin-right: 5px;">
		<use href="/static/sprites.svg#back"></use>
	</svg>
	Back to Admin Panel
</a>

<div class="container-fluid import-container">
    <h1 class="mb-4">Batch Import Users</h1>
    <div class="row gx-5">
        <!-- Left Column: CSV Format Information -->
        <div class="col-lg-6 csv-format-section">
            <div class="card mb-4">
                <div class="card-body">
                    <p>Upload a CSV file with the following format:</p>
                    <code>email;username;display_name;country;organization;group;visibility;can_submit;can_change_display_name;can_access_api_keys</code>
                    
                    <h6 class="mt-3">Example:</h6>
                    <pre>john@example.com;john123;John Doe;USA;MIT;b35apo;0;1;1;1
jane@example.com;jane456;Jane Smith;UK;Oxford;b35apo;3;0;0;1</pre>
                    

                        <strong>visibility</strong>:
                            <ul>
                                <li><code>0</code> = <strong>Public</strong>: Everyone can see results</li>
                                <li><code>1</code> = <strong>Organization</strong>: Only users from same organization</li>
                                <li><code>2</code> = <strong>Study group</strong>: Only users from same study group</li>
                                <li><code>3</code> = <strong>Private</strong>: Only the user can see results</li>
                            </ul>
                        </li>
                    
                    <div class="alert alert-info">

                        Email, username, and visibility are required. The last 3 columns (can_submit, can_change_display_name, can_access_api_keys) are optional and default to 1 (allowed).
                        <br/>
                        For example:
                        <pre>john@example.com;john123;;;;;0</pre>

                        All users will be created with a temporary password and marked as unverified. They will need to request a password change via "Forget password".
                    </div>
                </div>
            </div>
            
            <!-- Error Messages -->
            {% if errors %}
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title text-danger">Import Failed - Validation Errors</h5>
                    <ul class="mb-0">
                        {% for error in errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Upload Form and Results -->
        <div class="col-lg-6 upload-section">
            <!-- Upload Form -->
            <div class="card mb-4">
                <div class="card-body">
                    <!--<h5 class="card-title">Upload CSV File</h5>-->
                    <form method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="csvFile" class="form-label">Select CSV File</label>
                            <input type="file" class="form-control" id="csvFile" name="csvFile" accept=".csv" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="dryRun" name="dryRun">
                            <label class="form-check-label" for="dryRun">
                                Dry run, validate only
                            </label>
                        </div>
                        <div class="card card-btn" onclick="this.closest('form').submit();">
                            <div class="card-body text-center">
                                <i class="bi bi-upload"></i> Upload and Import
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Section -->
            <div class="table-column">
                <!-- Dry Run Results -->
                {% if info %}
                <div class="card mb-4">
                    <div class="card-body">
                        <p><strong>{{ info.message }}</strong></p>
                        <p>Validated <strong>{{ info.count }}</strong> user(s) successfully:</p>
                        {% if info.users %}
                        <div class="table-container">
                            <table class="table table-sm table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Display Name</th>
                                        <th>Country</th>
                                        <th>Organization</th>
                                        <th>Group</th>
                                        <th>Visibility</th>
                                        <th>Can Submit</th>
                                        <th>Change DispName</th>
                                        <th>API Access</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in info.users %}
                                    <tr>
                                        <td><strong>{{ user.username }}</strong></td>
                                        <td>{{ user.email }}</td>
                                        <td>{{ user.display_name if user.display_name else '<em class="text-muted">Not set</em>' | safe }}</td>
                                        <td>{{ user.country if user.country else '<em class="text-muted">Not set</em>' | safe }}</td>
                                        <td>{{ user.organization if user.organization else '<em class="text-muted">Not set</em>' | safe }}</td>
                                        <td>{{ user.group if user.group else '<em class="text-muted">Not set</em>' | safe }}</td>
                                        <td>
                                            {% if user.visibility == '0' %}Public
                                            {% elif user.visibility == '1' %}Organization
                                            {% elif user.visibility == '2' %}Study group
                                            {% elif user.visibility == '3' %}Private
                                            {% else %}{{ user.visibility }}
                                            {% endif %}
                                        </td>
                                        <td>{{ 'Yes' if user.can_submit == '1' else 'No' }}</td>
                                        <td>{{ 'Yes' if user.can_change_display_name == '1' else 'No' }}</td>
                                        <td>{{ 'Yes' if user.can_access_api_keys == '1' else 'No' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Success Results -->
                {% if success %}
                <div class="card mb-4">
                    <div class="card-body">
                        <p>Successfully imported <strong>{{ success.count }}</strong> user(s):</p>
                        <div class="table-container">
                            <table class="table table-sm table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Display Name</th>
                                        <th>Country</th>
                                        <th>Organization</th>
                                        <th>Group</th>
                                        <th>Visibility</th>
                                        <th>Can Submit</th>
                                        <th>Change DispName</th>
                                        <th>API Access</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in success.users %}
                                    <tr>
                                        <td><strong>{{ user.username }}</strong></td>
                                        <td>{{ user.email }}</td>
                                        <td>{{ user.display_name if user.display_name else '<em class="text-muted">Not set</em>' | safe }}</td>
                                        <td>{{ user.country if user.country else '<em class="text-muted">Not set</em>' | safe }}</td>
                                        <td>{{ user.organization if user.organization else '<em class="text-muted">Not set</em>' | safe }}</td>
                                        <td>{{ user.group if user.group else '<em class="text-muted">Not set</em>' | safe }}</td>
                                        <td>
                                            {% if user.visibility == '0' %}Public
                                            {% elif user.visibility == '1' %}Organization
                                            {% elif user.visibility == '2' %}Study group
                                            {% elif user.visibility == '3' %}Private
                                            {% else %}{{ user.visibility }}
                                            {% endif %}
                                        </td>
                                        <td>{{ 'Yes' if user.can_submit == '1' else 'No' }}</td>
                                        <td>{{ 'Yes' if user.can_change_display_name == '1' else 'No' }}</td>
                                        <td>{{ 'Yes' if user.can_access_api_keys == '1' else 'No' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}