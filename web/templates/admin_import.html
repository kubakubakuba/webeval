{% extends "base_wide.html" %}

{% block title %}Batch Import Users{% endblock %}

{% block content %}
<style>
/* Custom container override */
.container-fluid.import-container {
    max-width: none !important;
    padding: 25px !important;
    width: 100%;
}

/* Content styling */
.import-result-card {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}
html.dark-mode .import-result-card {
    background-color: #2a2a2a;
    border-color: #444;
}
.import-result-table {
    margin-top: 15px;
}
.import-result-table th {
    font-weight: 600;
}
.csv-format-section {
    padding-right: 25px;
}
.upload-section {
    padding-left: 25px;
    border-left: 1px solid #dee2e6;
}
html.dark-mode .upload-section {
    border-left-color: #444;
}
.table-column {
    padding-top: 25px;
}
/* Table adjustments */
.table-container {
    overflow-x: auto;
}
table {
    min-width: 600px;
}
</style>

<div class="container-fluid import-container">
    <h1 class="mb-4">Batch Import Users</h1>
    <div class="row gx-5">
        <!-- Left Column: CSV Format Information -->
        <div class="col-lg-6 csv-format-section">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">CSV Format</h5>
                    <p>Upload a CSV file with the following format (semicolon-separated):</p>
                    <code>email;username;display_name;country;organization;group;visibility</code>
                    
                    <h6 class="mt-3">Example:</h6>
                    <pre>john@example.com;john123;John Doe;USA;MIT;2024;0
jane@example.com;jane456;Jane Smith;UK;Oxford;2024;3</pre>
                    
                    <h6 class="mt-3">Fields:</h6>
                    <ul>
                        <li><strong>email</strong>: User's email address (required, unique)</li>
                        <li><strong>username</strong>: Username (required, unique)</li>
                        <li><strong>display_name</strong>: Display name (optional, use empty or leave blank)</li>
                        <li><strong>country</strong>: Country (optional)</li>
                        <li><strong>organization</strong>: Organization (optional)</li>
                        <li><strong>group</strong>: Group (optional)</li>
                        <li><strong>visibility</strong>: Privacy level (required):
                            <ul>
                                <li><code>0</code> = <strong>Public</strong>: Everyone can see results</li>
                                <li><code>1</code> = <strong>Organization</strong>: Only users from same organization</li>
                                <li><code>2</code> = <strong>Study group</strong>: Only users from same study group</li>
                                <li><code>3</code> = <strong>Private</strong>: Only the user can see results</li>
                            </ul>
                        </li>
                    </ul>
                    
                    <div class="alert alert-info">
                        <strong>Note:</strong> All users will be created with a temporary password and marked as unverified.
                        They will need to use the "Forgot Password" feature to set their password.
                    </div>
                </div>
            </div>
            
            <!-- Error Messages -->
            {% if errors %}
            <div class="card mb-4 import-result-card">
                <div class="card-body">
                    <h5 class="card-title text-danger">Import Failed - Validation Errors</h5>
                    <ul class="mb-0">
                        {% for error in errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Upload Form and Results -->
        <div class="col-lg-6 upload-section">
            <!-- Upload Form -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Upload CSV File</h5>
                    <form method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="csvFile" class="form-label">Select CSV File</label>
                            <input type="file" class="form-control" id="csvFile" name="csvFile" accept=".csv" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="dryRun" name="dryRun">
                            <label class="form-check-label" for="dryRun">
                                Dry run (validate only, don't import)
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-upload"></i> Upload and Import
                        </button>
                        <a href="/admin" class="btn btn-secondary w-100">Cancel</a>
                    </form>
                </div>
            </div>

            <!-- Results Section -->
            <div class="table-column">
                <!-- Dry Run Results -->
                {% if info %}
                <div class="card mb-4 import-result-card">
                    <div class="card-body">
                        <h5 class="card-title">Dry Run Result</h5>
                        <p><strong>{{ info.message }}</strong></p>
                        <p>Validated <strong>{{ info.count }}</strong> user(s) successfully:</p>
                        {% if info.users %}
                        <div class="table-container">
                            <table class="table table-sm table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Display Name</th>
                                        <th>Country</th>
                                        <th>Organization</th>
                                        <th>Group</th>
                                        <th>Visibility</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in info.users %}
                                    <tr>
                                        <td><strong>{{ user.username }}</strong></td>
                                        <td>{{ user.email }}</td>
                                        <td>{{ user.display_name if user.display_name else '<em class="text-muted">Not set</em>' | safe }}</td>
                                        <td>{{ user.country if user.country else '<em class="text-muted">Not set</em>' | safe }}</td>
                                        <td>{{ user.organization if user.organization else '<em class="text-muted">Not set</em>' | safe }}</td>
                                        <td>{{ user.group if user.group else '<em class="text-muted">Not set</em>' | safe }}</td>
                                        <td>
                                            {% if user.visibility == '0' %}Public
                                            {% elif user.visibility == '1' %}Organization
                                            {% elif user.visibility == '2' %}Study group
                                            {% elif user.visibility == '3' %}Private
                                            {% else %}{{ user.visibility }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Success Results -->
                {% if success %}
                <div class="card mb-4 import-result-card">
                    <div class="card-body">
                        <h5 class="card-title">Import Successful</h5>
                        <p>Successfully imported <strong>{{ success.count }}</strong> user(s):</p>
                        <div class="table-container">
                            <table class="table table-sm table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Display Name</th>
                                        <th>Country</th>
                                        <th>Organization</th>
                                        <th>Group</th>
                                        <th>Visibility</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in success.users %}
                                    <tr>
                                        <td><strong>{{ user.username }}</strong></td>
                                        <td>{{ user.email }}</td>
                                        <td>{{ user.display_name if user.display_name else '<em class="text-muted">Not set</em>' | safe }}</td>
                                        <td>{{ user.country if user.country else '<em class="text-muted">Not set</em>' | safe }}</td>
                                        <td>{{ user.organization if user.organization else '<em class="text-muted">Not set</em>' | safe }}</td>
                                        <td>{{ user.group if user.group else '<em class="text-muted">Not set</em>' | safe }}</td>
                                        <td>
                                            {% if user.visibility == '0' %}Public
                                            {% elif user.visibility == '1' %}Organization
                                            {% elif user.visibility == '2' %}Study group
                                            {% elif user.visibility == '3' %}Private
                                            {% else %}{{ user.visibility }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-warning mt-3 mb-0">
                            <strong>Important:</strong> All imported users must reset their password using the "Forgot Password" feature before they can log in.
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}