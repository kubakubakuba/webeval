{% extends "codemirror.html" %}

{% block title %}
	{{ task_name }}
{% endblock title %}

{% block content %}
<style>
	.back-link {
		display: inline-flex;
		align-items: center;
		margin-bottom: 20px;
		color: var(--link-color);
		text-decoration: none;
	}

	.back-link:hover {
		text-decoration: underline;
	}

	.card-btn:hover {
		background-color: #f8f9fa;
	}

	.card-btn{
		margin-bottom: 10px;
	}

	.cm-argument { color: #708090; font-style: italic; }
	.cm-failed { color: #DC143C; }
	.cm-passed { color: #228B22; }
	.cm-time-string { color: #4682B4; }
	.cm-register-memory { color: #217a7a }
	.cm-expected-number-value { color: #2E8B57; }
	.cm-provided-number-value { color: #DC143C; }
	.cm-error-value { color: #B22222; }

	.icon-link svg {
		stroke: #000000;
		fill: none;
	}

	html.dark-mode .icon-link svg {
		stroke: #ffffff !important;
	}

	.icon-link {
		color: inherit !important;
		text-decoration: none;
		display: inline-flex;
		align-items: center;
		vertical-align: middle;
	}

	.icon-link:hover {
		opacity: 0.7;
	}

	.icon-link:hover svg {
		stroke: currentColor;
	}

	html.dark-mode .icon-link:hover svg {
		stroke: #ffffff;
	}

	.score-row {
		display: flex;
		align-items: center;
		justify-content: flex-end;
		gap: 12px;
	}

	.score-value {
		min-width: 60px;
		text-align: right;
	}
</style>

<a href="/" class="back-link">
	<svg width="20" height="20" style="vertical-align: middle; margin-right: 5px;">
		<use href="/static/sprites.svg#back"></use>
	</svg>
	Back to Home
</a>

<div class="container-fluid">
	<div class="row">
		<!-- Main Content Column -->
		<div class="col-md-4">
			<!-- Preformatted markdown for task description -->
			{{ task.description | safe }}

			{% if makefile %}
				<details>
					<summary>Makefile (click)</summary>
					<pre><code>
						{{ makefile }}
					</code></pre>
				</details>
			{% endif %}

			{% if files %}
				<h6>Additional files present at compile time:</h6>
			
				{% for file in files %}
					<details>
						<summary>{{ file["name"] }} (click)</summary>
						<pre><code>
							{{ file["code"] }}
						</code></pre>
					</details>
				{% endfor %}
			{% endif %}

			<!-- Loop for task inputs -->
			{% if task.inputs %}

				{% for i in task.inputs %}
				<h6>Input: {{ i.description }}</h6>
				<div>
					<span>In:</span>  <code>{{ i.data_in }}</code> <br />
				</div>
				<div>
					<span>Out:</span> <code>{{ i.data_out }}</code> <br />
				</div>
				{% endfor %}
			
			{% endif %}
			<br />

			<!-- Display task arguments -->
			Your program will be run with the following arguments:
			<code>
				{{ task.arguments }}
			</code>

			<br />

			Your program will be scored by this following metric:
			<code>
				{{ task.scoring }}
			</code>
			
			<br /><br />

			For interactive solution, you can use <a href="https://github.com/cvut/qtrvsim">QtRvSim</a>. The web version of the simulator is located <a href="https://comparch.edu.cvut.cz/qtrvsim/app/" target="_blank">here</a>.
			<hr />

			{% if 'logged_in' in sessions %}
				{% if can_submit %}
					<div class="card card-btn">
						<a href="/submit/{{ task.id }}" class="card-body text-center text-decoration-none">
							Submit a solution
						</a>
					</div>
				{% endif %}

				{% if task.deadlines %}
					<div class="alert alert-info mt-3">
						{% if task.deadlines.start %}
							<strong>Opens:</strong> {{ task.deadlines.start.strftime('%B %d, %Y at %H:%M') }}<br />
						{% endif %}
						{% if task.deadlines.end %}
							<strong>Closes:</strong> {{ task.deadlines.end.strftime('%B %d, %Y at %H:%M') }}
						{% endif %}
					</div>
				{% endif %}
			{% endif %}
		</div>
			<!-- Submission section for logged-in users -->
		<div class="col-md-4">
			{% if 'logged_in' in sessions %}
				{% if submission_found %}
					<h5>Your latest submission:</h5>
					<div>
						<div>
							Submission result:
							{% if result == -1 %}
								<span style="color: rgb(239, 198, 15);">
									Pending

								<!-- Poll for evaluation status without reloading the page -->
								<script>
									let pollInterval;
									
									function checkEvaluationStatus() {
										fetch('/task_status/{{ task.id }}')
											.then(response => response.json())
											.then(data => {
												if (data.has_submission && data.is_evaluated) {
													// Evaluation complete, reload the page
													clearInterval(pollInterval);
													window.location.reload();
												}
											})
											.catch(error => {
												console.error('Error checking status:', error);
											});
									}
									
									// Check status every 3 seconds
									pollInterval = setInterval(checkEvaluationStatus, 3000);
									// Also check immediately
									checkEvaluationStatus();
								</script>
								</span>
							{% elif result == 0 %}
								<span style="color: green;">Accepted</span>
							{% elif result == 2 %}
								<span style="color: red;">Timeout</span>
							{% elif result == 3 %}
								<span style="color: red;">Cache error</span>
							{% elif result == 4 %}
								<span style="color: red;">Make error</span>
							{% elif result == 5 %}
								<span style="color: red;">Assembly error</span>
							{% elif result == 99 %}
								<span style="color: maroon;">Internal evaluator error</span>
							{% elif result == 100 %}
								<span style="color: maroon;">Score reset by admin</span>
							{% else %}
								<span style="color: red;">Rejected</span>
							{% endif %}
						</div>
						<div>
							Submission time:
							{{ time }}
						</div>

						{% if result == 0 %}
							<div>
								Score:
								<code>{{ score }}</code>
							</div>
						{% endif %}

						{% if issue_url %}
							<div>
								<b>Please report this issue on <a href="{{ issue_url }}">GitLab</a></b>
							</div>
						{% endif %}

						{% if result_file %}
							<div class="card">
								<div class="card-body" id="resultFileCodeMirror"></div>
							</div>
						{% endif %}

					</div>
				{% endif %}
			{% endif %}
		</div>

		<!-- Scoreboard Column -->
		<div class="col-md-4">
			<div class="card">
				<div class="card-header">
					Top Scores (cycles)
				</div>
				<ul class="list-group list-group-flush scrollable-list">
					{% for userid, score, name, is_best in scores %}
						{% if score is not none and score > 0 %}
							<li class="list-group-item {% if userid == session['user_id'] and is_best == 1 %}highlight-green{% elif userid == session['user_id'] and is_best == 0 %}highlight-yellow{% endif %}">
								<div class="row align-items-center">
									<div class="col-sm-6">
										{% if name is not none and name in displaynames and displaynames[name] is not none %}
											{{displaynames[name]}} ({{ name }})
										{% else %}
											{{ name }}
										{% endif %}
									</div>
									<div class="col-sm-6">
										<div class="score-row">
											<span class="score-value">{{ score }}</span>
											{% if session['user_id'] == userid or is_admin == 1 %}
												<a href="/view/{{ task.id }}/{{ userid }}/{% if is_best == 1 %}0{% elif is_best == 0 %}1{% endif %}" class="icon-link">
													<svg width="20" height="20">
														<use href="/static/sprites.svg#inspect"></use>
													</svg>
												</a>											<a href="/download/{{ task.id }}/{{ userid }}/{% if is_best == 1 %}1{% elif is_best == 0 %}0{% endif %}" class="icon-link">
												<svg width="20" height="20">
													<use href="/static/sprites.svg#download"></use>
												</svg>
											</a>											{% endif %}
											
											{% if is_admin == 1 %}
												<a href="/admin/reevaluate/{{ task.id }}/{{ userid }}/{% if is_best == 1 %}1{% elif is_best == 0 %}0{% endif %}" class="icon-link">
													<svg width="20" height="20">
														<use href="/static/sprites.svg#reevaluate"></use>
													</svg>
												</a>
											{% endif %}
										</div>
									</div>
								</div>
							</li>
						{% endif %}
					{% endfor %}
				</ul>
			</div>

			<!-- Admin: All Submissions Table -->
			{% if is_admin == 1 and all_submissions %}
			<div class="card" style="margin-top: 20px;">
			<div class="card-header" style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;" onclick="toggleAdminTable()">
				<svg width="16" height="16" id="admin-table-toggle">
					<use href="/static/sprites.svg#inspect"></use>
				</svg>
				<span>All Submissions</span>
				</div>
				<div id="admin-submissions-table" style="display: none;">
					<div class="card-body" style="padding: 10px;">
						<div style="margin-bottom: 10px;">
							<label>Sort by:</label>
							<select id="sort-select" onchange="sortAdminTable()" class="form-select form-select-sm" style="width: auto; display: inline-block; margin-left: 10px;">
								<option value="username">Username</option>
								<option value="score">Cycles (ascending)</option>
								<option value="score-desc">Cycles (descending)</option>
								<option value="result">Result Status</option>
							</select>
						</div>
					</div>
					<ul class="list-group list-group-flush scrollable-list" id="admin-submissions-list">
						{% for userid, result_code, score_val, time_val, username in all_submissions %}
							<li class="list-group-item" data-username="{{ username }}" data-score="{{ score_val if score_val else 999999999 }}" data-result="{{ result_code if result_code is not none else -999 }}">
								<div class="row align-items-center">
									<div class="col-sm-4">
										{% if username in displaynames and displaynames[username] is not none %}
											{{displaynames[username]}} ({{ username }})
										{% else %}
											{{ username }}
										{% endif %}
									</div>
									<div class="col-sm-4">
										{% if result_code == -1 %}
											<span style="color: rgb(239, 198, 15);">Pending</span>
										{% elif result_code == 0 %}
											<span style="color: green;">Accepted</span>
										{% elif result_code == 2 %}
											<span style="color: red;">Timeout</span>
										{% elif result_code == 3 %}
											<span style="color: red;">Cache error</span>
										{% elif result_code == 4 %}
											<span style="color: red;">Make error</span>
										{% elif result_code == 5 %}
											<span style="color: red;">Assembly error</span>
										{% elif result_code == 99 %}
											<span style="color: maroon;">Internal error</span>
										{% elif result_code == 100 %}
											<span style="color: maroon;">Score reset</span>
										{% elif result_code is none %}
											<span style="color: gray;">No submission</span>
										{% else %}
											<span style="color: red;">Rejected</span>
										{% endif %}
									</div>
									<div class="col-sm-4">
										<div class="score-row">
											<span class="score-value">
												{% if score_val is not none and score_val > 0 %}
													{{ score_val }}
												{% else %}
													-
												{% endif %}
											</span>
											<a href="/view/{{ task.id }}/{{ userid }}/1" class="icon-link">
												<svg width="20" height="20">
													<use href="/static/sprites.svg#inspect"></use>
												</svg>
											</a>
											<a href="/download/{{ task.id }}/{{ userid }}/0" class="icon-link">
												<svg width="20" height="20">
													<use href="/static/sprites.svg#download"></use>
												</svg>
											</a>
											<a href="/admin/reevaluate/{{ task.id }}/{{ userid }}/0" class="icon-link">
												<svg width="20" height="20">
													<use href="/static/sprites.svg#reevaluate"></use>
												</svg>
											</a>
										</div>
									</div>
								</div>
							</li>
						{% endfor %}
					</ul>
				</div>
			</div>

			<script>
				function toggleAdminTable() {
					const table = document.getElementById('admin-submissions-table');
					const toggle = document.getElementById('admin-table-toggle');
					const use = toggle.querySelector('use');
					if (table.style.display === 'none') {
						table.style.display = 'block';
						use.setAttribute('href', '/static/sprites.svg#disabled-task');
					} else {
						table.style.display = 'none';
						use.setAttribute('href', '/static/sprites.svg#inspect');
					}
				}

				function sortAdminTable() {
					const select = document.getElementById('sort-select');
					const sortBy = select.value;
					const list = document.getElementById('admin-submissions-list');
					const items = Array.from(list.getElementsByTagName('li'));

					items.sort((a, b) => {
						if (sortBy === 'username') {
							return a.dataset.username.localeCompare(b.dataset.username);
						} else if (sortBy === 'score') {
							return parseInt(a.dataset.score) - parseInt(b.dataset.score);
						} else if (sortBy === 'score-desc') {
							return parseInt(b.dataset.score) - parseInt(a.dataset.score);
						} else if (sortBy === 'result') {
							return parseInt(a.dataset.result) - parseInt(b.dataset.result);
						}
						return 0;
					});

					items.forEach(item => list.appendChild(item));
				}
			</script>
			{% endif %}

		</div>
	</div>
</div>
{% endblock content %}

{% block cmirror %}
	{% if result is not none and result > -1 %}
<script>
	CodeMirror.defineMode("qtrvsimLog", function() {
		return {
		token: function(stream, state) {

			if (stream.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/)) {
				//console.log(stream.current());
				return "time-string";
			}

			if (stream.match(/Arguments:.*$/)) {
				//console.log(stream.current());
				return "argument";
			}

			if (stream.match(/FAILED/)) {
				//console.log(stream.current());
				return "failed";
			}
			if (stream.match(/PASSED/)) {
				//console.log(stream.current());
				return "passed";
			}

			if (stream.match(/(register \w+|memory at 0x[0-9A-Fa-f]+)/)) {
				//console.log(stream.current());
				return "register-memory";
			}

			if (stream.match(/ \b\d+\b,/)) {
				//console.log(stream.current());
				return "expected-number-value";
			}
			
			if (stream.match(/ \b\d+\b$/)) {
				//console.log(stream.current());
				return "provided-number-value";
			}

			// Default token
			stream.next();
			return null;
		}
		};
	});
	
	CodeMirror.defineMIME("text/qtrvsimLog", "qtrvsimLog");
	</script>

	<script>
		let resultFileContent = {{ result_file|tojson }};
		let resultFileEditor = CodeMirror(document.getElementById("resultFileCodeMirror"), {
			lineNumbers: true,
			mode: "qtrvsimLog",
			lineWrapping: true,
			viewportMargin: Infinity,
			readOnly: true
		});

		resultFileEditor.setSize("auto", "auto");
		resultFileEditor.setValue(resultFileContent);
	</script>
	{% endif %}
{% endblock %}

