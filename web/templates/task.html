{% extends "codemirror.html" %}

{% block title %}
	{{ task_name }}
{% endblock title %}

{% block content %}
<style>
	.card-btn:hover {
		background-color: #f8f9fa;
	}

	.card-btn{
		margin-bottom: 10px;
	}

	.cm-argument { color: #708090; font-style: italic; }
	.cm-failed { color: #DC143C; }
	.cm-passed { color: #228B22; }
	.cm-time-string { color: #4682B4; }
	.cm-register-memory { color: #217a7a }
	.cm-expected-number-value { color: #2E8B57; }
	.cm-provided-number-value { color: #DC143C; }
	.cm-error-value { color: #B22222; }


</style>
<div class="container">
	<div class="row">
		<!-- Main Content Column -->
		<div class="col-md-8">
			<!-- Preformatted markdown for task description -->
			{{ task.description | safe}}

			<!-- Loop for task inputs -->
			{% for i in task.inputs %}
				<h6>Input {{ loop.index }}: {{ i.description }}</h6>
				<div>
					<span>In:</span>  <code>{{ i.data_in }}</code> <br />
				</div>
				<div>
					<span>Out:</span> <code>{{ i.data_out }}</code> <br />
				</div>
			{% endfor %}
			<br />

			<!-- Display task arguments -->
			Your program will be run with the following arguments:
			<code>
				{{ task.arguments }}
			</code>

			<br />

			Your program will be scored by this following metric:
			<code>
				{{ task.scoring }}
			</code>
			<hr />

			<!-- Submission section for logged-in users -->
			{% if 'logged_in' in sessions %}
				<div class="card card-btn">
					<a href="/submit/{{ task.id }}" class="card-body text-center text-decoration-none">
						Submit a solution
					</a>
				</div>
				{% if submission_found %}
					<h5>Your latest submission:</h5>
					<div>
						<div>
							Submission result:
							{% if result == -1 %}
								<span style="color: rgb(239, 198, 15);">Pending</span>
							{% elif result == 0 %}
								<span style="color: green;">Accepted</span>
							{% elif result == 2 %}
								<span style="color: red;">Timeout</span>
							{% else %}
								<span style="color: red;">Rejected</span>
							{% endif %}
						</div>
						<div>
							Time submitted:
							{{ time }}
						</div>

						{% if result == 0 %}
							<div>
								Score:
								<code>{{ score }}</code>
							</div>
						{% endif %}

						{% if result_file %}
							<div class="card">
								<div class="card-body" id="resultFileCodeMirror"></div>
							</div>
						{% endif %}
						
					</div>
				{% endif %}
			{% endif %}
		</div>

		<!-- Scoreboard Column -->
		<div class="col-md-4">
			<div class="card">
				<div class="card-header">
					Top Scores (cycles)
				</div>
				<ul class="list-group list-group-flush scrollable-list">
					{% for userid, score, name, is_best in scores %}
						{% if score > 0 %}
							<li class="list-group-item {% if userid == session['user_id'] and is_best == 1 %}highlight-green{% elif userid == session['user_id'] and is_best == 0 %}highlight-yellow{% endif %}">
								<div class="row">
									<div class="col-sm-8">
										{{ name }}
									</div>
									<div class="col-sm-4 border-left">
										{{ score }}
									</div>
								</div>
							</li>
						{% endif %}
					{% endfor %}
				</ul>
			</div>
		</div>
	</div>
</div>
{% endblock content %}

{% block cmirror %}
	<script>
	CodeMirror.defineMode("qtrvsimLog", function() {
		return {
		token: function(stream, state) {

			if (stream.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/)) {
				//console.log(stream.current());
				return "time-string";
			}

			if (stream.match(/Arguments:.*$/)) {
				//console.log(stream.current());
				return "argument";
			}

			if (stream.match(/FAILED/)) {
				//console.log(stream.current());
				return "failed";
			}
			if (stream.match(/PASSED/)) {
				//console.log(stream.current());
				return "passed";
			}

			if (stream.match(/(register \w+|memory at 0x[0-9A-Fa-f]+)/)) {
				//console.log(stream.current());
				return "register-memory";
			}

			if (stream.match(/ \b\d+\b,/)) {
				//console.log(stream.current());
				return "expected-number-value";
			}

			if (stream.match(/ \b\d+\b$/)) {
				//console.log(stream.current());
				return "provided-number-value";
			}
			// Default token
			stream.next();
			return null;
		}
		};
	});
	
	CodeMirror.defineMIME("text/qtrvsimLog", "qtrvsimLog");
	</script>

	<script>
		let resultFileContent = {{ result_file|tojson }};
		let resultFileEditor = CodeMirror(document.getElementById("resultFileCodeMirror"), {
			lineNumbers: true,
			mode: "qtrvsimLog",
			lineWrapping: true,
			viewportMargin: Infinity,
			readOnly: true,
		});

		resultFileEditor.setSize("500px", "500px");
		resultFileEditor.setValue(resultFileContent);
	</script>
{% endblock %}
